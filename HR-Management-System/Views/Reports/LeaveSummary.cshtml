@model LeaveSummaryReport
@{
    ViewData["Title"] = "Leave Summary Report";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">
        <i class="fas fa-calendar-check me-2"></i>Leave Summary Report
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="/Reports" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i>Back to Reports
        </a>
        <button class="btn btn-success" onclick="printReport()">
            <i class="fas fa-print me-1"></i>Print Report
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Leave Requests
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalLeaveRequests</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Approved Leaves
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ApprovedLeaves</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Pending Approval
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.PendingLeaves</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Rejected Leaves
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.RejectedLeaves</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Leave Requests by Type</h5>
            </div>
            <div class="card-body">
                <canvas id="leaveTypeChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Leave Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="leaveStatusChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Leave by Type Table -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="card-title mb-0">
            <i class="fas fa-table me-2"></i>Leave Breakdown by Type
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Leave Type</th>
                        <th>Number of Requests</th>
                        <th>Percentage</th>
                        <th>Average Duration (Days)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.LeaveByType)
                    {
                        <tr>
                            <td>
                                <span class="badge bg-info">@item.Type</span>
                            </td>
                            <td>@item.Count</td>
                            <td>@item.Percentage.ToString("F1")%</td>
                            <td>
                                @{
                                    var avgDuration = Model.LeaveByType.Average(x => x.Count);
                                    <span class="fw-bold">@avgDuration.ToString("F1")</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Department Leave Analysis -->
<div class="card">
    <div class="card-header bg-white">
        <h5 class="card-title mb-0">
            <i class="fas fa-building me-2"></i>Department-wise Leave Analysis
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="departmentTable">
                <thead class="table-dark">
                    <tr>
                        <th>Department</th>
                        <th>Total Employees</th>
                        <th>Total Leave Requests</th>
                        <th>Approved Leaves</th>
                        <th>Approval Rate</th>
                        <th>Avg. Leaves per Employee</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var dept in Model.LeaveByDepartment)
                    {
                        var approvalRate = dept.TotalLeaves > 0 ? (decimal)dept.ApprovedLeaves / dept.TotalLeaves * 100 : 0;
                        var avgLeaves = dept.EmployeeCount > 0 ? (decimal)dept.TotalLeaves / dept.EmployeeCount : 0;

                        <tr>
                            <td>
                                <strong>@dept.Department</strong>
                            </td>
                            <td>@dept.EmployeeCount</td>
                            <td>@dept.TotalLeaves</td>
                            <td>@dept.ApprovedLeaves</td>
                            <td>
                                <span class="badge @(approvalRate >= 80 ? "bg-success" : approvalRate >= 60 ? "bg-warning" : "bg-danger")">
                                    @approvalRate.ToString("F1")%
                                </span>
                            </td>
                            <td>@avgLeaves.ToString("F1")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize DataTable
            $('#departmentTable').DataTable({
                "order": [[5, "desc"]],
                "responsive": true
            });

            // Load leave type chart
            loadLeaveTypeChart();
            loadLeaveStatusChart();
        });

        function loadLeaveTypeChart() {
            const ctx = document.getElementById('leaveTypeChart').getContext('2d');
            const chartData = {
                labels: [@Html.Raw(string.Join(", ", Model.LeaveByType.Select(x => $"'{x.Type}'")))],
                datasets: [{
                    data: [@string.Join(", ", Model.LeaveByType.Select(x => x.Count))],
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                    ],
                    borderWidth: 1
                }]
            };

            new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function loadLeaveStatusChart() {
            const ctx = document.getElementById('leaveStatusChart').getContext('2d');
            const chartData = {
                labels: ['Approved', 'Pending', 'Rejected'],
                datasets: [{
                    data: [@Model.ApprovedLeaves, @Model.PendingLeaves, @Model.RejectedLeaves],
                    backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
                    borderWidth: 1
                }]
            };

            new Chart(ctx, {
                type: 'pie',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function printReport() {
            window.print();
        }
    </script>
}